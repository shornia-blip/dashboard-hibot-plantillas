<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Plantillas WhatsApp</title>
    <!-- 1. Importar Chart.js y el plugin de etiquetas -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #111827; /* Fondo gris oscuro */
            color: #e5e7eb; /* Texto claro */
            margin: 0;
            padding: 20px;
        }
        h1, h3 {
            text-align: center;
            color: #ffffff;
            font-weight: 500;
        }
        
        /* Contenedor principal */
        .dashboard-container {
            display: grid;
            grid-template-columns: 1fr; /* Una columna para todo */
            gap: 20px;
            max-width: 1400px;
            margin: 20px auto;
        }
        
        /* Tarjetas de Estadísticas (IN vs OUT) */
        .stats-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .stat-card {
            background-color: #1f2937; /* Fondo de tarjeta */
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            text-align: center;
        }
        .stat-card h3 {
            margin-top: 0;
            font-size: 1.1rem;
            color: #9ca3af; /* Color de título de tarjeta */
        }
        .stat-card .value {
            font-size: 2.5rem;
            font-weight: 600;
            color: #ffffff;
        }
        .stat-card .percentage {
            font-size: 1.2rem;
            color: #6b7280; /* Color de porcentaje */
        }

        /* Contenedor de Gráfico y Tabla */
        .chart-box, .table-container {
            background-color: #1f2937; /* Fondo de tarjeta */
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        /* Estilos de la Tabla */
        .table-container {
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        th, td {
            border: 1px solid #374151; /* Borde más oscuro */
            padding: 10px;
            text-align: left;
        }
        th {
            background-color: #374151; /* Cabecera de tabla */
            font-size: 0.9rem;
            text-transform: uppercase;
            color: #d1d5db;
        }
        td {
            color: #e5e7eb;
        }
        
        /* Colores de Límite */
        .limite-ok {
            background-color: #064e3b;
            color: #a7f3d0;
            font-weight: bold;
            text-align: center;
        }
        .limite-alerta {
            background-color: #7f1d1d;
            color: #fecaca;
            font-weight: bold;
            text-align: center;
        }
    </style>
</head>
<body>

    <h1>Dashboard de Uso de Plantillas (HIBOT)</h1>

    <div class="dashboard-container">
        
        <!-- 1. Tarjetas de Estadísticas -->
        <div class="stats-container" id="stats-cards">
            <!-- Los datos se cargarán aquí -->
            <div class="stat-card">
                <h3>Conversaciones (IN)</h3>
                <div class="value">0</div>
                <div class="percentage">(0.0%)</div>
            </div>
            <div class="stat-card">
                <h3>Conversaciones (OUT)</h3>
                <div class="value">0</div>
                <div class="percentage">(0.0%)</div>
            </div>
        </div>

        <!-- 2. Gráfico de Barras Diario -->
        <div class="chart-box">
            <h3>Uso Diario (Conversaciones OUT)</h3>
            <canvas id="graficoDiario"></canvas>
        </div>
        
        <!-- 3. Tabla de Desglose por Agente -->
        <div class="table-container">
            <h3>Desglose por Agente (Conversaciones 'OUT' - 30 días)</h3>
            <div id="tablaAgentes">
                <p>Cargando datos de agentes...</p>
            </div>
        </div>
    </div>

    <script>
        // Registrar el plugin de etiquetas
        Chart.register(ChartDataLabels);

        // Paleta de colores (Azul de Reino)
        const COLOR_AZUL_REINO = '#0d1bd4';
        const COLOR_TEXTO_GRAFICO = '#e5e7eb'; // Texto claro

        // Guardamos las instancias de los gráficos
        let chartDiarioInstance = null;
        
        // --- ¡CORRECCIÓN! ---
        // URL absoluta al backend en Render.
        // Esto soluciona el error 'Failed to parse URL' en la vista previa
        // y también funciona cuando está desplegado.
        const API_URL = 'https://dashboard-reino-backend.onrender.com/api/datos';
        // ------------------


        // Función principal de JavaScript
        async function cargarDatos() {
            try {
                // Llama a la API (ahora con la URL absoluta)
                // Se autenticará con la ventana emergente del navegador
                const response = await fetch(API_URL);
                
                if (!response.ok) {
                    // Si el login (401) falla, el navegador lo maneja.
                    // Esto es para errores 500, etc.
                    throw new Error(`Error del servidor: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (!data) {
                    throw new Error("La respuesta del servidor está vacía o no es un JSON válido.");
                }

                // 1. Renderizar tarjetas (IN vs OUT)
                if (data.direccion_data && data.direccion_data.acumulado) {
                    renderizarTarjetas(data.direccion_data.acumulado);
                }

                // 2. Renderizar el gráfico diario
                if (data.direccion_data && data.direccion_data.diario) {
                    renderizarGraficoDiario(data.direccion_data.diario);
                }

                // 3. Renderizar la tabla de agentes
                if (data.agente_data) {
                    renderizarTablaAgentes(data.agente_data);
                }

            } catch (error) {
                console.error('Error al cargar el dashboard:', error);
                document.body.innerHTML = `<h1>Error al cargar datos: ${error.message}</h1><p>Asegúrate de que el script de Python (app.py) se esté ejecutando y no tenga errores. Revisa la consola del backend y la consola del navegador (F12).</p>`;
            }
        }

        function renderizarTarjetas(data) {
            // data = data.direccion_data.acumulado
            const container = document.getElementById('stats-cards');
            const total = data.conteo.reduce((a, b) => a + b, 0);
            
            const idxIN = data.plantillas.indexOf('IN');
            const idxOUT = data.plantillas.indexOf('OUT');
            
            const conteoIN = (idxIN !== -1) ? data.conteo[idxIN] : 0;
            const conteoOUT = (idxOUT !== -1) ? data.conteo[idxOUT] : 0;
            
            const porcIN = (total > 0) ? (conteoIN / total * 100).toFixed(1) : 0;
            const porcOUT = (total > 0) ? (conteoOUT / total * 100).toFixed(1) : 0;

            container.innerHTML = `
                <div class="stat-card">
                    <h3>Conversaciones (IN)</h3>
                    <div class="value">${conteoIN.toLocaleString('es-AR')}</div>
                    <div class="percentage">(${porcIN}%)</div>
                </div>
                <div class="stat-card">
                    <h3>Conversaciones (OUT)</h3>
                    <div class="value">${conteoOUT.toLocaleString('es-AR')}</div>
                    <div class="percentage">(${porcOUT}%)</div>
                </div>
            `;
        }

        function renderizarGraficoDiario(data) {
            // data = data.direccion_data.diario
            const ctx = document.getElementById('graficoDiario').getContext('2d');
            
            if (chartDiarioInstance) {
                chartDiarioInstance.destroy();
            }
            
            // Extraer solo los datos de 'OUT'
            const datosOUT = data.fechas.map(fecha => {
                return data.datos[fecha] ? data.datos[fecha]['OUT'] || 0 : 0;
            });
            
            chartDiarioInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.fechas, // Eje X (fechas '29/10')
                    datasets: [
                        {
                            label: 'Conversaciones OUT',
                            data: datosOUT,
                            backgroundColor: COLOR_AZUL_REINO,
                            borderColor: COLOR_AZUL_REINO
                        }
                    ]
                },
                options: {
                    aspectRatio: 3, // Proporción: 3 veces más ancho que alto
                    responsive: true,
                    plugins: {
                        legend: {
                            labels: { color: COLOR_TEXTO_GRAFICO } // Color de la leyenda
                        },
                        datalabels: { // Configuración de etiquetas de datos
                            display: true,
                            color: COLOR_TEXTO_GRAFICO,
                            anchor: 'end',
                            align: 'top',
                            formatter: (value) => (value > 0 ? value : ''), // No mostrar '0'
                            font: { weight: 'bold' }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: COLOR_TEXTO_GRAFICO, // Color de las fechas
                                maxRotation: 60, // Rotar fechas
                                minRotation: 60, // Rotar fechas
                                autoSkip: true // Saltear fechas si se superponen
                            },
                            grid: {
                                color: '#374151' // Color de líneas de fondo
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: COLOR_TEXTO_GRAFICO, // Color del eje Y
                                stepSize: 1 // Forzar números enteros (1, 2, 3...)
                            },
                            grid: {
                                color: '#374151' // Color de líneas de fondo
                            }
                        }
                    }
                }
            });
        }
        
        function renderizarTablaAgentes(data) {
            // data = data.agente_data
            const container = document.getElementById('tablaAgentes');
            if (!data || data.length === 0) {
                container.innerHTML = "<p>No se encontraron datos de agentes para conversaciones 'OUT'.</p>";
                return;
            }
            
            let html = '<table>';
            html += `
                <tr>
                    <th>Tienda</th>
                    <th>Límite de Usos Hoy (20)</th>
                    <th>Rol</th>
                    <th>Agente</th>
                    <th>Total Usos (30 días)</th>
                </tr>
            `;
            
            data.forEach(tienda => {
                const totalHoy = tienda.total_tienda_hoy;
                const limite = tienda.limite_diario;
                const claseLimite = totalHoy >= limite ? 'limite-alerta' : 'limite-ok';
                
                if (tienda.agentes.length > 0) {
                    const primeraFilaAgente = tienda.agentes[0];
                    // Primera fila de la tienda (con rowspan)
                    html += `
                        <tr>
                            <td rowspan="${tienda.agentes.length}">${tienda.tienda}</td>
                            <td rowspan="${tienda.agentes.length}" class="${claseLimite}">
                                ${totalHoy} / ${limite}
                            </td>
                            <td>${primeraFilaAgente.rol}</td>
                            <td>${primeraFilaAgente.nombre}</td>
                            <td>${primeraFilaAgente.total_usos}</td>
                        </tr>
                    `;
                    
                    // Resto de agentes de la tienda
                    for (let i = 1; i < tienda.agentes.length; i++) {
                        const agente = tienda.agentes[i];
                        html += `
                            <tr>
                                <td>${agente.rol}</td>
                                <td>${agente.nombre}</td>
                                <td>${agente.total_usos}</td>
                            </tr>
                        `;
                    }
                } else {
                    // Si una tienda no tiene agentes (raro, pero seguro)
                    html += `
                        <tr>
                            <td>${tienda.tienda}</td>
                            <td class="${claseLimite}">${totalHoy} / ${limite}</td>
                            <td colspan="3"><em>(Sin agentes con conversaciones 'OUT')</em></td>
                        </tr>
                    `;
                }
            });
            
            html += '</table>';
            container.innerHTML = html;
        }

        // Ejecutar la función al cargar la página
        cargarDatos();
    </script>

</body>
</html>

