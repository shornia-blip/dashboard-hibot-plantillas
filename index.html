<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Plantillas WhatsApp</title>
    <!-- 1. Importar Chart.js y el plugin de etiquetas -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #111827; /* Fondo gris oscuro */
            color: #e5e7eb; /* Texto claro */
            margin: 0;
            padding: 20px;
        }
        h1, h3 {
            text-align: center;
            color: #ffffff;
            font-weight: 500;
        }
        
        /* Contenedor principal */
        .dashboard-container {
            display: grid;
            grid-template-columns: 1fr; /* Una columna para todo */
            gap: 20px;
            max-width: 1400px;
            margin: 20px auto;
        }
        
        /* Tarjetas de Estadísticas (IN vs OUT) */
        .stats-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .stat-card {
            background-color: #1f2937; /* Fondo de tarjeta */
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            text-align: center;
        }
        .stat-card h3 {
            margin-top: 0;
            font-size: 1.1rem;
            color: #9ca3af; /* Color de título de tarjeta */
        }
        .stat-card .value {
            font-size: 2.5rem;
            font-weight: 600;
            color: #ffffff;
        }
        .stat-card .percentage {
            font-size: 1.2rem;
            color: #6b7280; /* Color de porcentaje */
        }

        /* Contenedor de Gráfico y Tabla */
        .chart-box, .table-container, .filter-container {
            background-color: #1f2937; /* Fondo de tarjeta */
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        /* --- NUEVO: Contenedor de Gráficos Diarios --- */
        .charts-diarios-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        /* --- NUEVO: Estilos de Filtros --- */
        .filter-container {
            padding-bottom: 25px;
        }
        .filter-container h3 {
            margin-top: 0;
            text-align: left;
        }
        .filter-container .botones-filtro {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .filter-container button {
            background-color: #374151;
            color: #e5e7eb;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .filter-container button:hover {
            background-color: #4b5563;
        }
        .filter-container button.active {
            background-color: #0d1bd4; /* Azul de Reino */
            color: #ffffff;
        }


        /* Estilos de la Tabla */
        .table-container {
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        th, td {
            border: 1px solid #374151; /* Borde más oscuro */
            padding: 10px;
            text-align: left;
        }
        th {
            background-color: #374151; /* Cabecera de tabla */
            font-size: 0.9rem;
            text-transform: uppercase;
            color: #d1d5db;
        }
        td {
            color: #e5e7eb;
        }
        
        /* Colores de Límite */
        .limite-ok {
            background-color: #064e3b;
            color: #a7f3d0;
            font-weight: bold;
            text-align: center;
        }
        .limite-alerta {
            background-color: #7f1d1d;
            color: #fecaca;
            font-weight: bold;
            text-align: center;
        }

        /* Media query para pantallas pequeñas */
        @media (max-width: 900px) {
            .stats-container {
                grid-template-columns: 1fr;
            }
            .charts-diarios-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>

    <h1>Dashboard de Uso de Plantillas (HIBOT)</h1>

    <div class="dashboard-container">
        
        <!-- 1. Tarjetas de Estadísticas -->
        <div class="stats-container" id="stats-cards">
            <!-- Los datos se cargarán aquí -->
            <div class="stat-card">
                <h3>Conversaciones (IN)</h3>
                <div class="value">0</div>
                <div class="percentage">(0.0%)</div>
            </div>
            <div class="stat-card">
                <h3>Conversaciones (OUT)</h3>
                <div class="value">0</div>
                <div class="percentage">(0.0%)</div>
            </div>
        </div>

        <!-- 2. Contenedor de Filtros -->
        <div class="filter-container">
            <h3>Filtar por Tienda</h3>
            <div class="botones-filtro" id="filtros-container">
                <button class="active" onclick="filtrarGraficos('Total', this)">Todos</button>
                <!-- Botones de tiendas se cargarán aquí -->
            </div>
        </div>

        <!-- 3. Gráficos de Barras Diarios -->
        <div class="charts-diarios-container">
            <div class="chart-box">
                <h3>Uso Diario (Conversaciones OUT)</h3>
                <canvas id="graficoDiarioOUT"></canvas>
            </div>
            <div class="chart-box">
                <h3>Uso Diario (Conversaciones IN)</h3>
                <canvas id="graficoDiarioIN"></canvas>
            </div>
        </div>
        
        <!-- 4. Tabla de Desglose por Agente -->
        <div class="table-container">
            <h3>Desglose por Agente (Conversaciones 'OUT' - 30 días)</h3>
            <div id="tablaAgentes">
                <p>Cargando datos de agentes...</p>
            </div>
        </div>
    </div>

    <script>
        // Registrar el plugin de etiquetas
        Chart.register(ChartDataLabels);

        // Paleta de colores
        const COLOR_AZUL_REINO = '#0d1bd4';
        const COLOR_GRIS = '#4b5563';
        const COLOR_TEXTO_GRAFICO = '#e5e7eb'; // Texto claro

        // Guardamos las instancias de los gráficos
        let chartDiarioOUTInstance = null;
        let chartDiarioINInstance = null;
        
        // Almacén global para los datos de los gráficos
        let globalChartData = {};

        // URL de la API (corregida)
        const API_URL = '/api/datos'; // Usar ruta relativa

        // Función principal de JavaScript
        async function cargarDatos() {
            try {
                const response = await fetch(API_URL);
                
                if (!response.ok) {
                    throw new Error(`Error del servidor: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (!data) {
                    throw new Error("La respuesta del servidor está vacía o no es un JSON válido.");
                }

                // Almacenar datos globalmente
                globalChartData = data.datos_diarios_por_tienda;

                // 1. Renderizar tarjetas (Acumulado)
                if (data.resumen_acumulado) {
                    renderizarTarjetas(data.resumen_acumulado);
                }
                
                // 2. Renderizar filtros
                if (data.tiendas_disponibles) {
                    renderizarFiltros(data.tiendas_disponibles);
                }

                // 3. Renderizar gráficos (Vista "Total" por defecto)
                if (globalChartData.Total) {
                    renderizarGraficoDiarioOUT(globalChartData.Total);
                    renderizarGraficoDiarioIN(globalChartData.Total);
                }

                // 4. Renderizar la tabla de agentes
                if (data.tabla_agentes) {
                    renderizarTablaAgentes(data.tabla_agentes);
                }

            } catch (error) {
                console.error('Error al cargar el dashboard:', error);
                document.body.innerHTML = `<h1>Error al cargar datos: ${error.message}</h1><p>Asegúrate de que el script de Python (app.py) se esté ejecutando y no tenga errores. Revisa la consola del backend y la consola del navegador (F12).</p>`;
            }
        }

        function renderizarTarjetas(data) {
            // data = data.resumen_acumulado
            const container = document.getElementById('stats-cards');
            const total = data.conteo.reduce((a, b) => a + b, 0);
            
            const idxIN = data.plantillas.indexOf('IN');
            const idxOUT = data.plantillas.indexOf('OUT');
            
            const conteoIN = (idxIN !== -1) ? data.conteo[idxIN] : 0;
            const conteoOUT = (idxOUT !== -1) ? data.conteo[idxOUT] : 0;
            
            const porcIN = (total > 0) ? (conteoIN / total * 100).toFixed(1) : 0;
            const porcOUT = (total > 0) ? (conteoOUT / total * 100).toFixed(1) : 0;

            container.innerHTML = `
                <div class="stat-card">
                    <h3>Conversaciones (IN)</h3>
                    <div class="value">${conteoIN.toLocaleString('es-AR')}</div>
                    <div class="percentage">(${porcIN}%)</div>
                </div>
                <div class="stat-card">
                    <h3>Conversaciones (OUT)</h3>
                    <div class="value">${conteoOUT.toLocaleString('es-AR')}</div>
                    <div class="percentage">(${porcOUT}%)</div>
                </div>
            `;
        }

        function renderizarFiltros(tiendas) {
            const container = document.getElementById('filtros-container');
            // Empezar desde 1 para saltar el botón "Todos" que ya está en el HTML
            let html = container.innerHTML; // Conservar el botón "Todos"
            tiendas.forEach(tienda => {
                // Filtrar "Supervisión" si no se quiere mostrar
                if (tienda !== "Supervisión") {
                     html += `<button onclick="filtrarGraficos('${tienda}', this)">${tienda}</button>`;
                }
            });
            container.innerHTML = html;
        }

        // --- NUEVA FUNCIÓN DE FILTRADO ---
        function filtrarGraficos(tienda, elementoBoton) {
            // Actualizar clase activa en botones
            const botones = document.querySelectorAll('.botones-filtro button');
            botones.forEach(btn => btn.classList.remove('active'));
            if (elementoBoton) {
                elementoBoton.classList.add('active');
            } else {
                // Si se llama por defecto, activar el botón "Todos"
                document.querySelector('.botones-filtro button').classList.add('active');
            }

            // Obtener datos filtrados
            const data = globalChartData[tienda];
            if (!data) {
                console.error(`No se encontraron datos para la tienda: ${tienda}`);
                return;
            }

            // Volver a dibujar ambos gráficos
            renderizarGraficoDiarioOUT(data);
            renderizarGraficoDiarioIN(data);
        }

        // --- GRÁFICO OUT (MODIFICADO) ---
        function renderizarGraficoDiarioOUT(data) {
            // data = globalChartData[tienda]
            const ctx = document.getElementById('graficoDiarioOUT').getContext('2d');
            
            if (chartDiarioOUTInstance) {
                chartDiarioOUTInstance.destroy(); // Destruir gráfico anterior
            }
            
            chartDiarioOUTInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.fechas, // Eje X (fechas '29/10')
                    datasets: [
                        {
                            label: 'Conversaciones OUT',
                            data: data.OUT, // Usar datos OUT
                            backgroundColor: COLOR_AZUL_REINO,
                            borderColor: COLOR_AZUL_REINO
                        }
                    ]
                },
                options: {
                    aspectRatio: 2.5, // Más ancho que alto
                    responsive: true,
                    plugins: {
                        legend: {
                            labels: { color: COLOR_TEXTO_GRAFICO }
                        },
                        datalabels: {
                            display: true,
                            color: COLOR_TEXTO_GRAFICO,
                            anchor: 'end',
                            align: 'top',
                            formatter: (value) => (value > 0 ? value : ''),
                            font: { weight: 'bold' }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: COLOR_TEXTO_GRAFICO,
                                maxRotation: 60,
                                minRotation: 60,
                                autoSkip: true
                            },
                            grid: { color: '#374151' }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: COLOR_TEXTO_GRAFICO,
                                stepSize: 1
                            },
                            grid: { color: '#374151' }
                        }
                    }
                }
            });
        }

        // --- NUEVO GRÁFICO IN ---
        function renderizarGraficoDiarioIN(data) {
            // data = globalChartData[tienda]
            const ctx = document.getElementById('graficoDiarioIN').getContext('2d');
            
            if (chartDiarioINInstance) {
                chartDiarioINInstance.destroy(); // Destruir gráfico anterior
            }
            
            chartDiarioINInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.fechas, // Eje X (fechas '29/10')
                    datasets: [
                        {
                            label: 'Conversaciones IN',
                            data: data.IN, // Usar datos IN
                            backgroundColor: COLOR_GRIS, // Color gris
                            borderColor: COLOR_GRIS
                        }
                    ]
                },
                options: {
                    aspectRatio: 2.5, // Más ancho que alto
                    responsive: true,
                    plugins: {
                        legend: {
                            labels: { color: COLOR_TEXTO_GRAFICO }
                        },
                        datalabels: {
                            display: true,
                            color: COLOR_TEXTO_GRAFICO,
                            anchor: 'end',
                            align: 'top',
                            formatter: (value) => (value > 0 ? value : ''),
                            font: { weight: 'bold' }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: COLOR_TEXTO_GRAFICO,
                                maxRotation: 60,
                                minRotation: 60,
                                autoSkip: true
                            },
                            grid: { color: '#374151' }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: COLOR_TEXTO_GRAFICO,
                                stepSize: 5 // El StepSize puede ser mayor para IN
                            },
                            grid: { color: '#374151' }
                        }
                    }
                }
            });
        }
        
        function renderizarTablaAgentes(data) {
            // data = data.tabla_agentes
            const container = document.getElementById('tablaAgentes');
            if (!data || data.length === 0) {
                container.innerHTML = "<p>No se encontraron datos de agentes para conversaciones 'OUT'.</p>";
                return;
            }
            
            let html = '<table>';
            html += `
                <tr>
                    <th>Tienda</th>
                    <th>Límite de Usos Hoy (20)</th>
                    <th>Rol</th>
                    <th>Agente</th>
                    <th>Total Usos (30 días)</th>
                </tr>
            `;
            
            data.forEach(tienda => {
                const totalHoy = tienda.total_tienda_hoy;
                const limite = tienda.limite_diario;
                const claseLimite = totalHoy >= limite ? 'limite-alerta' : 'limite-ok';
                
                if (tienda.agentes.length > 0) {
                    const primeraFilaAgente = tienda.agentes[0];
                    // Primera fila de la tienda (con rowspan)
                    html += `
                        <tr>
                            <td rowspan="${tienda.agentes.length}">${tienda.tienda}</td>
                            <td rowspan="${tienda.agentes.length}" class="${claseLimite}">
                                ${totalHoy} / ${limite}
                            </td>
                            <td>${primeraFilaAgente.rol}</td>
                            <td>${primeraFilaAgente.nombre}</td>
                            <td>${primeraFilaAgente.total_usos}</td>
                        </tr>
                    `;
                    
                    // Resto de agentes de la tienda
                    for (let i = 1; i < tienda.agentes.length; i++) {
                        const agente = tienda.agentes[i];
                        html += `
                            <tr>
                                <td>${agente.rol}</td>
                                <td>${agente.nombre}</td>
                                <td>${agente.total_usos}</td>
                            </tr>
                        `;
                    }
                } else {
                    // Si una tienda no tiene agentes (raro, pero seguro)
                    html += `
                        <tr>
                            <td>${tienda.tienda}</td>
                            <td class="${claseLimite}">${totalHoy} / ${limite}</td>
                            <td colspan="3"><em>(Sin agentes con conversaciones 'OUT')</em></td>
                        </tr>
                    `;
                }
            });
            
            html += '</table>';
            container.innerHTML = html;
        }

        // Ejecutar la función al cargar la página
        cargarDatos();
    </script>

</body>
</html>

